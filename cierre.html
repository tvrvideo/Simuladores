<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Cierre con lamas</title>
  <style>
    /* =========================================
       ESTILOS GENERALES
       ========================================= */
    body {
      touch-action: manipulation;
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background: #FDFDFB;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 15px;
      gap: 15px;
      color: #333;
    }

    h1 {
      margin: 0;
      font-size: 28px;
      color: #0061FE;
      text-align: center;
      margin-bottom: 10px;
    }

    /* CONTENEDOR PRINCIPAL */
    form {
      display: flex;
      flex-direction: column;
      gap: 15px;
      background: #E9E0D2; /* Color crema original */
      padding: 20px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      width: 100%;
      max-width: 600px;
      box-shadow: 0 12px 15px rgba(0,0,0,0.2);
      box-sizing: border-box;
    }

    /* GRID DE INPUTS (5 Columnas) */
    .dimensions-group { display: flex; flex-direction: column; gap: 5px; }
    .dimensions-labels-row, .dimensions-inputs-row {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 10px;
        text-align: center;
    }
    
    label {
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 2px;
        color: #333;
    }

    input, select {
      width: 100%;
      padding: 10px 5px;
      border: 2px solid #000;
      border-radius: 8px;
      font-size: 16px; /* 16px para evitar zoom automático en iPhone */
      text-align: center;
      background-color: #fffacd;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      box-sizing: border-box;
    }

    
    /* SELECTORES DE COLOR (IGUALES AL ORIGINAL) */
    .color-row { display: flex; gap: 12px; }
    .color-picker-button {
        flex: 1;
        padding: 16px 10px;
        font-size: 16px;
        font-weight: 600;
        border: none;
        border-radius: 14px;
        background: #4b5563;
        color: #ffffff;
        text-align: center;
        box-shadow: 0 6px 10px rgba(0,0,0,0.3);
        position: relative;
    }
    .color-picker-button input[type="color"] {
        position: absolute;
        inset: 0;
        opacity: 0;
        cursor: pointer;
    }


    /* BOTONES RAL */
    .ral-buttons-container {
      display: grid;
      grid-template-columns: repeat(5, 1fr); 
      gap: 10px;
    }
    .ral-button {
      cursor: pointer;
      padding: 8px;
      border-radius: 8px;
      font-size: 12px;
      border: 2px solid #000;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      aspect-ratio: 1;
      box-shadow: 0 4px 6px rgba(0,0,0,0.2);
    }
    .ral-button span:first-child { font-weight: bold; margin-bottom: 2px; }
    .ral-button.selected { border: 3px solid #0061FE; transform: scale(1.05); }

    /* =========================================
       DISEÑO DE BOTONES DE ACCIÓN (ESTILO FOTO 1)
       ========================================= */
    .button-row {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr)); /* 4 columnas */
      gap: 12px;
      width: 100%;
      margin-top: 10px;
    }

    .action-button {
      cursor: pointer;
      background-color: #1e3a8a; /* AZUL OSCURO ORIGINAL */
      color: #fff;

      /* Tamaño uniforme para todos */
      height: 64px;
      width: 100%;
      padding: 0 6px;

      /* Texto centrado y encajado */
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      font-size: 13px;
      font-weight: 600;
      line-height: 1.1;
      white-space: normal;
      word-break: break-word;
      hyphens: auto;

      border-radius: 12px;
      border: none;
      box-shadow: 0 6px 10px rgba(0,0,0,0.3); /* SOMBRA FUERTE */
      transition: all 0.2s ease;
      min-width: 0; /* clave para 4 columnas */
    }

    .action-button:active { transform: translateY(2px); box-shadow: 0 2px 5px rgba(0,0,0,0.3); }

    /* Estado activo (blanco con borde azul) */
    .action-button.active {
      background-color: #e0eaff;
      color: #374151;
      border: 2px solid #1e3a8a;
      box-shadow: inset 0 2px 5px rgba(0,0,0,0.1);
    }

    /* SVG y ESTADÍSTICAS */
    svg {
      border: 1px solid #9ca3af;
      background: #fff;
      width: 100%;
      max-width: 600px;
      height: auto;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .stats {
      font-size: 16px;
      color: #374151;
      text-align: center;
      font-weight: bold;
      padding: 10px;
      background: #fff;
      border-radius: 8px;
      width: 100%;
      max-width: 600px;
      box-sizing: border-box;
    }

    .btn-menu { 
      position: fixed; top: 10px; left: 10px; z-index: 9999; 
      padding: 8px 15px; border-radius: 20px; background: #e74c3c; 
      color: white; font-weight: bold; border: none; cursor: pointer;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
  
    /* Exportar PNG */
    #btnExportPng{
      grid-column: 1 / -1;
      background-color: #2c3e50;
      box-shadow: 0 8px 14px rgba(0,0,0,0.35);
      font-weight: 800;
    }
    #btnExportPng:active{ transform: translateY(2px); box-shadow: 0 3px 7px rgba(0,0,0,0.35); }
    
    /* --- LAYOUT: CONTROLES CON SCROLL + VISTA (SVG) FIJA ABAJO --- */
    html, body { height: 100%; }
    body {
      padding: 0;               /* el padding pasa a #controls */
    }

    /* Controles: scroll */
    #controls {
      width: 100%;
      box-sizing: border-box;
      padding: 15px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 15px;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      /* deja hueco para el panel fijo */
      }

    /* Panel fijo inferior: vista */
    #preview {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      background: #FDFDFB;
      border-top: 1px solid #d1d5db;
      box-shadow: 0 -10px 24px rgba(0,0,0,0.12);
      padding: 10px 15px 15px;
      box-sizing: border-box;
      max-height: 48vh;
      overflow: auto;
      -webkit-overflow-scrolling: touch;
      z-index: 5000; /* por debajo del menú (9999) */
    }

    #preview-inner{
      max-width: 600px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }

    #preview svg{
      width: 100%;
      max-width: 600px;
      height: auto;
    }
    #preview .stats{
      width: 100%;
      max-width: 600px;
    }


/* Versión en el título (más pequeña) */
h1 .ver{
  font-size: 0.55em;
  font-weight: 700;
  margin-left: 8px;
  opacity: 0.75;
}

/* BOTÓN FIJAR (activar/desactivar vista fija abajo) */
.btn-fijar{
  position: fixed;
  top: 10px;
  right: 10px;
  z-index: 9999;
  padding: 10px 15px;
  border-radius: 20px;
  border: none;
  background: #6b7280; /* gris (desactivado) */
  color: #ffffff;
  font-weight: bold;
  box-shadow: 0 2px 5px rgba(0,0,0,0.2);
  cursor: pointer;
  font-size: 0.9rem;
  width: auto !important;
  display: inline-flex !important;
  align-items: center;
  justify-content: center;
  -webkit-tap-highlight-color: transparent;
}
.btn-fijar.active{ background: #e74c3c; } /* rojo activado */

/* Wrappers: en modo normal no afectan (como en Grados) */
/* --- MODO FIJO (solo cuando FIJAR está activado) --- */
:root{ --dock-height: 48vh; }

body.dock-on{
  margin: 0;
  padding: 0;
}

/* zona superior (controles) */
body.dock-on #scrollArea{
  display: block;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: var(--dock-height);
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  padding: 15px;
  box-sizing: border-box;
  background: #FDFDFB;
}

/* zona inferior (dibujo) */
body.dock-on #dockArea{
  display: block;
  position: fixed;
  left: 0;
  right: 0;
  bottom: 0;
  height: var(--dock-height);
  overflow: auto;
  -webkit-overflow-scrolling: touch;
  padding: 10px 15px 15px;
  box-sizing: border-box;
  background: #FDFDFB;
  border-top: 1px solid rgba(0,0,0,0.12);
  box-shadow: 0 -8px 18px rgba(0,0,0,0.12);
  z-index: 5000; /* por debajo del menú */
}
body.dock-on #dockArea #preview{ width: 100%; }
body.dock-on #dockArea #preview-inner{ max-width: 600px; margin: 0 auto; }

/* Export: overlay para que no haya que hacer scroll */
#vista-exportar{
  position: fixed;
  inset: 0;
  z-index: 10000;
  overflow: auto;
  -webkit-overflow-scrolling: touch;
  padding: 60px 12px 20px;
  box-sizing: border-box;
  background: #FDFDFB;
}


/* --- MODO NORMAL (FIJAR desactivado): todo en flujo normal, SIN panel fijo --- */
#scrollArea{
  position: static;
  display: block;
  width: 100%;
  box-sizing: border-box;
}

#dockArea{
  position: static;
  display: block;
  width: 100%;
  box-sizing: border-box;
}

/* El preview NO debe ser fijo por defecto (evita bloquear pantalla) */
#preview{
  position: static !important;
  inset: auto !important;
  max-height: none !important;
  box-shadow: none !important;
  border-top: none !important;
  padding: 0 !important;
  overflow: visible !important;
  z-index: auto !important;
}


/* Cuando FIJAR está activo, dejamos un poco de aire al final de los controles */
body.dock-on #controls{
  padding-bottom: 20px;
}

</style>
</head>
<body>

<div id="scrollArea"><div id="vista-diseno">


<button class="btn-menu" onclick="if(window.parent && window.parent.volverMenu){window.parent.volverMenu()}">← MENÚ</button>
<button id="btnFijar" class="btn-fijar" type="button">FIJAR</button>


<h1>Cierre con lamas <span class="ver">V16</span></h1>

<form id="form">
    <div class="dimensions-group">
        <div class="dimensions-labels-row">
            <label>Ancho</label><label>Alto</label><label>Lama</label><label>Marco</label><label>Hueco</label>
        </div>
        <div class="dimensions-inputs-row">
            <input type="number" id="ancho" value="2000">
            <input type="number" id="alto" value="900">
            <input type="number" id="altoLama" value="200">
            <input type="number" id="marco" value="50">
            <input type="number" id="sep" value="20" step="0.5">
        </div>
    </div>

    <div class="color-row">
        <div class="color-picker-button" id="btnMarcoWrapper">
            Color Marco <br>
            <input type="color" id="colorMarcoPicker" value="#4b5563">
        </div>
        <div class="color-picker-button" id="btnLamaWrapper">
            Color Lama <br>
            <input type="color" id="colorLamaPicker" value="#4b5563">
        </div>
    </div>

    <div class="ral-buttons-container" id="ral-buttons">
        <div class="ral-button" data-color="#2b2c7c" data-ral="5010"><span>RAL</span><span>5010</span></div>
        <div class="ral-button" data-color="#1c1c1c" data-ral="9005"><span>RAL</span><span>9005</span></div>
        <div class="ral-button" data-color="#374447" data-ral="7016"><span>RAL</span><span>7016</span></div>
        <div class="ral-button" data-color="#6c7074" data-ral="7043"><span>RAL</span><span>7043</span></div>
        <div class="ral-button" data-color="#e4e6e7" data-ral="9010"><span>RAL</span><span>9010</span></div>
        <div class="ral-button" data-color="#44322d" data-ral="8017"><span>RAL</span><span>8017</span></div>
        <div class="ral-button" data-color="#543c2c" data-ral="8014"><span>RAL</span><span>8014</span></div>
        <div class="ral-button" data-color="#92886f" data-ral="7034"><span>RAL</span><span>7034</span></div>
        <div class="ral-button" data-color="#d0b084" data-ral="1001"><span>RAL</span><span>1001</span></div>
        <div class="ral-button" data-color="#F7B500" data-ral="1023"><span>RAL</span><span>1023</span></div>
        <div class="ral-button" data-color="#1b542c" data-ral="6009"><span>RAL</span><span>6009</span></div>
        <div class="ral-button" data-color="#28713e" data-ral="6005"><span>RAL</span><span>6005</span></div>
        <div class="ral-button" data-color="#48a43f" data-ral="6018"><span>RAL</span><span>6018</span></div>
        <div class="ral-button" data-color="#8d1d2c" data-ral="3005"><span>RAL</span><span>3005</span></div>
        <div class="ral-button" data-color="#e86b16" data-ral="2004"><span>RAL</span><span>2004</span></div>
    </div>

    <div style="width:100%">
        <label id="lblUtiles">Alto lamas (mm)</label>
        <input type="number" id="altoUtillamas">
    </div>

    <div class="button-row">
        <button type="button" class="action-button" id="toggleDistrMode">Variar huecos</button>
        <button type="button" class="action-button" id="toggleWidthCota">Ocultar ancho</button>
        <button type="button" class="action-button" id="toggleHeightCota">Ocultar alto</button>
        <button type="button" class="action-button" id="toggleRedCota">Mostrar cota roja</button>
        <button type="button" class="action-button" id="toggleMarco">Ocultar marco</button>
        <button type="button" class="action-button" id="toggleOrientation">Cambiar horizontal</button>
        <button type="button" class="action-button" id="toggleLarguero">Añadir larguero</button>
        <button type="button" class="action-button" id="togglePoste">Añadir poste</button>
    </div>
        <button type="button" class="action-button" id="btnExportPng">Exportar PNG</button>

</form>
</div></div>

<div id="dockArea">
<div id="preview"><div id="preview-inner">

<svg id="canvas" viewBox="0 0 900 800"></svg>
<div class="stats" id="stats"></div>
</div></div>

<div id="controls">

</div>
</div>

<div id="vista-exportar" style="display:none; width:100%; max-width:600px;">
  <div style="background:#E9E0D2; padding:20px; border-radius:8px; border:1px solid #d1d5db; box-shadow:0 12px 15px rgba(0,0,0,0.2); text-align:center; box-sizing:border-box;">
    <h2 style="margin:0 0 12px 0; color:#1e3a8a;">IMAGEN GENERADA</h2>
    <img id="img-resultado" alt="PNG" style="max-width:100%; border-radius:10px; border:2px solid #ddd; box-shadow:0 6px 12px rgba(0,0,0,0.25);" />
    <p style="margin:12px 0 0; font-size:0.9em; color:#555;">Mantén pulsada la imagen para guardarla</p>
    <button type="button" class="action-button" id="btnBackDesign" style="margin-top:14px; width:100%;">← VOLVER AL DISEÑO</button>
  </div>
</div>

<script>
    // --- LÓGICA COMPLETA ---
    let showWidthCota = true, showHeightCota = true, showRedCota = false, showMarco = true, isVertical = false, isLamaMode = false;
    let showLarguero = false, showPoste = false, originalAltoLama = 200, updatingFromDraw = false, scale = 1;

    function getContrastColor(hex) {
        const r = parseInt(hex.substring(1, 3), 16), g = parseInt(hex.substring(3, 5), 16), b = parseInt(hex.substring(5, 7), 16);
        return ((r * 299 + g * 587 + b * 114) / 1000) > 125 ? '#000' : '#fff';
    }

    function createRect(x, y, w, h, fill, stroke = "none", sw = 0) {
        const r = document.createElementNS("http://www.w3.org/2000/svg", "rect");
        r.setAttribute("x", x); r.setAttribute("y", y); r.setAttribute("width", w); r.setAttribute("height", h);
        r.setAttribute("fill", fill); r.setAttribute("stroke", stroke);
        if(sw > 0) r.setAttribute("stroke-width", sw / scale);
        return r;
    }
    function createLine(x1, y1, x2, y2, stroke, sw) {
        const l = document.createElementNS("http://www.w3.org/2000/svg", "line");
        l.setAttribute("x1", x1); l.setAttribute("y1", y1); l.setAttribute("x2", x2); l.setAttribute("y2", y2);
        l.setAttribute("stroke", stroke); l.setAttribute("stroke-width", sw / scale);
        return l;
    }
    function createPoly(points, stroke) {
        const p = document.createElementNS("http://www.w3.org/2000/svg", "polyline");
        p.setAttribute("points", points); p.setAttribute("fill", "none");
        p.setAttribute("stroke", stroke); p.setAttribute("stroke-width", 1/scale);
        return p;
    }

    function drawDimLineSVG(x1, y1, x2, y2, text, vertical, level = 1, color = "#1d4ed8", alignRight = false, invertText = false, textBelowLine = false) {
        const g = document.getElementById("canvas").querySelector("g");
        const lineOffset = (-15 / scale) + (level - 1) * (20 / scale);
        const textOffset = lineOffset + (35 / scale);
        const fontSize = 50 / scale;
        const arrowSize = 5 / scale;

        let lx1, ly1, lx2, ly2, tx, ty;
        if (vertical) {
            lx1 = lx2 = alignRight ? x1 + lineOffset : x1 - lineOffset;
            ly1 = y1; ly2 = y2;
            tx = alignRight ? x1 + textOffset : x1 - textOffset;
            ty = (y1 + y2) / 2;
        } else {
            lx1 = x1; lx2 = x2;
            ly1 = ly2 = textBelowLine ? y1 + lineOffset : y1 - lineOffset;
            tx = (x1 + x2) / 2;
            ty = textBelowLine ? y1 + textOffset : y1 - textOffset;
        }

        g.appendChild(createLine(lx1, ly1, lx2, ly2, color, 1.5));
        
        let p1, p2;
        if(vertical) {
            p1 = `${lx1-arrowSize},${ly1+arrowSize} ${lx1},${ly1} ${lx1+arrowSize},${ly1+arrowSize}`;
            p2 = `${lx2-arrowSize},${ly2-arrowSize} ${lx2},${ly2} ${lx2+arrowSize},${ly2-arrowSize}`;
        } else {
            p1 = `${lx1+arrowSize},${ly1-arrowSize} ${lx1},${ly1} ${lx1+arrowSize},${ly1+arrowSize}`;
            p2 = `${lx2-arrowSize},${ly2-arrowSize} ${lx2},${ly2} ${lx2-arrowSize},${ly2+arrowSize}`;
        }
        g.appendChild(createPoly(p1, color));
        g.appendChild(createPoly(p2, color));

        const t = document.createElementNS("http://www.w3.org/2000/svg", "text");
        t.setAttribute("x", tx); t.setAttribute("y", ty); t.setAttribute("fill", color);
        t.setAttribute("font-size", fontSize); t.setAttribute("text-anchor", "middle"); t.setAttribute("dominant-baseline", "middle");
        if (vertical) t.setAttribute("transform", `rotate(${invertText ? -90 : 90} ${tx} ${ty})`);
        t.textContent = text;
        g.appendChild(t);
    }

    function drawCierre() {
        const ancho = +document.getElementById("ancho").value, alto = +document.getElementById("alto").value;
        const marco = +document.getElementById("marco").value, altoLamaInput = +document.getElementById("altoLama").value;
        const sep = +document.getElementById("sep").value;
        const cMarco = document.getElementById("colorMarcoPicker").value;
        const cLama = document.getElementById("colorLamaPicker").value;

        const svg = document.getElementById("canvas");
        svg.innerHTML = '';
        // --- Escala con márgenes (para que no quede pegado a los lados) ---
        const canvasW = 900;
        const canvasH = 800;
        const padding = 140; // margen alrededor del dibujo y sus cotas
        scale = Math.min((canvasW - 2 * padding) / ancho, (canvasH - 2 * padding) / alto);

        const g = document.createElementNS("http://www.w3.org/2000/svg", "g");
        g.setAttribute("transform", `translate(${(canvasW - ancho * scale)/2}, ${(canvasH - alto * scale)/2}) scale(${scale})`);
        svg.appendChild(g);

        if(showMarco) {
            g.appendChild(createRect(0, 0, ancho, alto, cMarco, "#000", 1));
            g.appendChild(createRect(marco, marco, ancho - marco*2, alto - marco*2, "#fff", "#000", 1));
        }

        let areaUtil = isVertical ? (ancho - marco*2) : (alto - marco*2), n, esp, nuevoAL = altoLamaInput;
        if (isLamaMode) {
            n = Math.round(areaUtil / (altoLamaInput + sep));
            if (n > 0) nuevoAL = (areaUtil - (n+1)*sep) / n;
            if(!updatingFromDraw) document.getElementById("altoLama").value = Math.round(nuevoAL);
            esp = sep;
        } else {
            n = Math.floor(areaUtil / (altoLamaInput + sep));
            esp = n > 0 ? (areaUtil - n * altoLamaInput) / (n + 1) : 0;
        }

        for(let i=0; i<n; i++) {
            const pos = marco + esp + i*(nuevoAL + esp);
            if(isVertical) g.appendChild(createRect(pos, marco, nuevoAL, alto - marco*2, cLama, "#000", 0.5));
            else g.appendChild(createRect(marco, pos, ancho - marco*2, nuevoAL, cLama, "#000", 0.5));
        }

        if(showLarguero && ancho > 1000) {
            g.appendChild(createRect(ancho/2 - marco, 0, marco, alto, cMarco, "#fff", 0.5));
            g.appendChild(createRect(ancho/2 + 5, 0, marco, alto, cMarco, "#fff", 0.5));
        }
        if(showPoste) {
            if(isVertical) g.appendChild(createRect(0, alto/2 - marco/2, ancho, marco, cMarco, "#000", 0.5));
            else g.appendChild(createRect(ancho/2 - marco/2, 0, marco, alto, cMarco, "#000", 0.5));
        }

        const cotaUtil = n * nuevoAL + (n-1)*esp;
        if(!updatingFromDraw) document.getElementById("altoUtillamas").value = Math.round(cotaUtil);

        if(showWidthCota) drawDimLineSVG(0, 0, ancho, 0, ancho + " mm", false, 3);
        if(showHeightCota) drawDimLineSVG(0, 0, 0, alto, alto + " mm", true, 3, "#1d4ed8", false, true);
        if(showRedCota && n > 0) {
            if(isVertical) drawDimLineSVG(marco+esp, alto, marco+esp+cotaUtil, alto, Math.round(cotaUtil)+" mm", false, 4, "#ef4444", false, false, true);
            else drawDimLineSVG(ancho, marco+esp, ancho, marco+esp+cotaUtil, Math.round(cotaUtil)+" mm", true, 4, "#ef4444", true, true);
        }

        document.getElementById("stats").textContent = `Lamas: ${n} | Hueco: ${Math.round(esp)} mm | Lama: ${Math.round(nuevoAL)} mm`;
    }

    // --- EVENTOS ---
    const inputs = document.querySelectorAll('input:not([type="color"])');
    inputs.forEach(input => input.addEventListener('input', () => {
        updatingFromDraw = (input.id === "altoUtillamas");
        if(updatingFromDraw) {
            const val = +input.value, m = +document.getElementById("marco").value, al = +document.getElementById("altoLama").value, s = +document.getElementById("sep").value;
            const n = Math.floor(val / (al + s));
            const total = (n*al) + (n+1)*((val - n*al)/(n+1)) + 2*m;
            if(isVertical) document.getElementById("ancho").value = Math.round(total);
            else document.getElementById("alto").value = Math.round(total);
        }
        drawCierre();
    }));

    // Control de Colores
    function updateColorBtn(wrapperId, color) {
        const wrapper = document.getElementById(wrapperId);
        wrapper.style.borderColor = color;
        // Para los botones grandes no cambiamos el fondo entero para no tapar el texto,
        // pero podemos poner un borde grueso o un pequeño indicador.
        // En este diseño tipo "Foto 1", el botón suele ser blanco con borde de color o fondo claro.
        // Ajustamos ligeramente:
        wrapper.style.borderLeft = `10px solid ${color}`;
    }
    
    document.getElementById("colorMarcoPicker").oninput = (e) => {
        updateColorBtn("btnMarcoWrapper", e.target.value);
        drawCierre();
    };
    document.getElementById("colorLamaPicker").oninput = (e) => {
        updateColorBtn("btnLamaWrapper", e.target.value);
        drawCierre();
    };

    // RAL Buttons logic
    document.querySelectorAll('.ral-button').forEach(btn => {
        const c = btn.dataset.color;
        btn.style.backgroundColor = c; 
        btn.style.color = getContrastColor(c);
        btn.onclick = () => {
            document.querySelectorAll('.ral-button').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            document.getElementById("colorMarcoPicker").value = c;
            document.getElementById("colorLamaPicker").value = c;
            updateColorBtn("btnMarcoWrapper", c);
            updateColorBtn("btnLamaWrapper", c);
            drawCierre();
        };
    });

    const actionIds = ["toggleDistrMode", "toggleWidthCota", "toggleHeightCota", "toggleRedCota", "toggleMarco", "toggleOrientation", "toggleLarguero", "togglePoste"];
    actionIds.forEach(id => {
        document.getElementById(id).onclick = (e) => {
            if(id === "toggleDistrMode") { isLamaMode = !isLamaMode; e.target.textContent = isLamaMode ? "Variar lamas" : "Variar huecos"; }
            if(id === "toggleWidthCota") showWidthCota = !showWidthCota;
            if(id === "toggleHeightCota") showHeightCota = !showHeightCota;
            if(id === "toggleRedCota") showRedCota = !showRedCota;
            if(id === "toggleMarco") showMarco = !showMarco;
            if(id === "toggleOrientation") { isVertical = !isVertical; document.getElementById("lblUtiles").textContent = isVertical ? "Ancho lamas (mm)" : "Alto lamas (mm)"; }
            if(id === "toggleLarguero") showLarguero = !showLarguero;
            if(id === "togglePoste") showPoste = !showPoste;
            e.target.classList.toggle("active");
            drawCierre();
        };
    });

    updateColorBtn("btnMarcoWrapper", document.getElementById("colorMarcoPicker").value);
    updateColorBtn("btnLamaWrapper", document.getElementById("colorLamaPicker").value);
    drawCierre();
    // --- EXPORTAR PNG (como en poligono) ---
    function exportarPNG() {
        const svg = document.getElementById('canvas');
        const svgData = (new XMLSerializer()).serializeToString(svg);
        const svgBlob = new Blob([svgData], {type: 'image/svg+xml;charset=utf-8'});
        const url = URL.createObjectURL(svgBlob);

        const img = new Image();
        img.onload = function() {
            const ratio = 2; // calidad
            const canvas = document.createElement('canvas');
            canvas.width = 900 * ratio;
            canvas.height = 800 * ratio;
            const ctx = canvas.getContext('2d');

            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

            document.getElementById('img-resultado').src = canvas.toDataURL('image/png');

            // Guardar estado de FIJAR y desactivarlo para exportar
            window.__cierreWasDockOn = document.body.classList.contains('dock-on');
            setDockCierre(false);
            const _scrollArea = document.getElementById('scrollArea');
            const _dockArea = document.getElementById('dockArea');
            if(_scrollArea) _scrollArea.style.display = 'none';
            if(_dockArea) _dockArea.style.display = 'none';
            document.getElementById('vista-diseno').style.display = 'none';
            document.getElementById('vista-exportar').style.display = 'block';

            URL.revokeObjectURL(url);
        };
        img.onerror = function() {
            URL.revokeObjectURL(url);
            alert('No se pudo generar la imagen.');
        };
        img.src = url;
    }

    document.getElementById('btnExportPng').addEventListener('click', exportarPNG, {passive:true});
    document.getElementById('btnBackDesign').addEventListener('click', () => {
        document.getElementById('vista-exportar').style.display = 'none';
        // Mostrar diseño completo
        const _scrollArea = document.getElementById('scrollArea');
        const _dockArea = document.getElementById('dockArea');
        if(_scrollArea) _scrollArea.style.display = '';
        if(_dockArea) _dockArea.style.display = '';
        document.getElementById('vista-diseno').style.display = 'block';

        // Restaurar FIJAR si estaba activado
        if (window.__cierreWasDockOn) {
          setDockCierre(true);
        }
    }, {passive:true});


// --- FIJAR (Cierre) ---
function setDockCierre(on){
  document.body.classList.toggle('dock-on', on);
  const btn = document.getElementById('btnFijar');
  if(btn) btn.classList.toggle('active', on);
}

// Por defecto: desactivado (gris)
setDockCierre(false);

const __btnFijar = document.getElementById('btnFijar');
if(__btnFijar){
  __btnFijar.addEventListener('click', () => {
    const on = !__btnFijar.classList.contains('active');
    setDockCierre(on);
  }, {passive:true});
}

</script>
</body>
</html>
